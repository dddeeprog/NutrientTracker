@file:OptIn(ExperimentalMaterial3Api::class)

package com.example.nutrienttrackerv1.ui

import android.content.Context
import android.net.Uri
import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.compose.setContent
import androidx.activity.result.contract.ActivityResultContracts.CreateDocument
import androidx.activity.viewModels
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.Assessment
import androidx.compose.material.icons.filled.Download
import androidx.compose.material.icons.filled.List
import androidx.compose.material.icons.filled.Settings
import androidx.compose.material.icons.filled.Today
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import com.example.nutrienttrackerv1.data.*
import kotlinx.coroutines.launch
import java.io.OutputStreamWriter
import androidx.activity.result.contract.ActivityResultContracts.PickVisualMedia
import androidx.compose.material.icons.filled.SmartToy
import coil.compose.AsyncImage
import com.example.nutrienttrackerv1.ai.*
import androidx.compose.ui.text.input.PasswordVisualTransformation
import androidx.activity.result.PickVisualMediaRequest
import androidx.activity.result.contract.ActivityResultContracts
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.withContext



// ============== Activity ==============
class MainActivity : ComponentActivity() {
    private val vm: MainViewModel by viewModels()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContent { AppScaffold(vm) }
    }
}

// ============== Scaffold / Tabs ==============
enum class Tab(val label: String, val icon: @Composable () -> Unit) {
    Today("‰ªäÊó•", { Icon(Icons.Filled.Today, contentDescription = null) }),
    Add("ËÆ∞ÂΩï", { Icon(Icons.Filled.Add, contentDescription = null) }),
    Foods("È£üÁâ©Â∫ì", { Icon(Icons.Filled.List, contentDescription = null) }),
    Goals("ÁõÆÊ†á", { Icon(Icons.Filled.Settings, contentDescription = null) }),
    Export("ÂØºÂá∫", { Icon(Icons.Filled.Download, contentDescription = null) }),
    Trend("Ë∂ãÂäø", { Icon(Icons.Filled.Assessment, contentDescription = null) }),

    AI("AI", { Icon(Icons.Filled.SmartToy, contentDescription = null) }),

}

@Composable
fun AppScaffold(vm: MainViewModel) {
    var tab by remember { mutableStateOf(Tab.Today) }

    Scaffold(
        topBar = { TopAppBar(title = { Text("ü•ó Nutrient Tracker (Android)") }) },
        bottomBar = {
            NavigationBar {
                Tab.values().forEach {
                    NavigationBarItem(
                        selected = tab == it,
                        onClick = { tab = it },
                        icon = it.icon,
                        label = { Text(it.label) }
                    )
                }
            }
        }
    ) { inner ->
        Box(Modifier.padding(inner)) {
            val day by vm.day.collectAsState()
            when (tab) {
                Tab.Today -> TodayScreen(vm, day)
                Tab.Add -> AddEntryScreen(vm)
                Tab.Foods -> FoodScreen(vm)
                Tab.Goals -> GoalsScreen(vm)
                Tab.Export -> ExportScreen(vm)
                Tab.Trend -> TrendScreen(vm)
                Tab.AI -> AiScreen(vm)
            }
        }
    }
}

// ============== Screens ==============
@Composable
fun TodayScreen(vm: MainViewModel, day: DaySummary?) {
    val scroll = rememberScrollState()
    val today = vm.today.collectAsState().value

    Column(Modifier.padding(16.dp).verticalScroll(scroll)) {
        Text("Êó•ÊúüÔºö$today", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
        Spacer(Modifier.height(8.dp))

        val state = day
        if (state == null) {
            Text("Âä†ËΩΩ‰∏≠‚Ä¶")
            return
        }

        Text("ËøõÂ∫¶ÔºàÁõ∏ÂØπÊØèÊó•ÁõÆÊ†áÔºâ", fontWeight = FontWeight.Bold)
        Spacer(Modifier.height(8.dp))
        NUTRIENTS_META.forEach { nm ->
            val value = state.totals[nm.key] ?: 0.0
            val target = when (nm.key) {
                "calories_kcal" -> state.goal.calories_kcal
                "protein_g" -> state.goal.protein_g
                "carbs_g" -> state.goal.carbs_g
                "fat_g" -> state.goal.fat_g
                "fiber_g" -> state.goal.fiber_g
                "sugar_g" -> state.goal.sugar_g
                "sodium_mg" -> state.goal.sodium_mg
                "calcium_mg" -> state.goal.calcium_mg
                "iron_mg" -> state.goal.iron_mg
                "vitamin_c_mg" -> state.goal.vitamin_c_mg
                else -> 0.0
            } ?: 0.0
            val ratio = if (target <= 0) 0f else (value / target).toFloat().coerceIn(0f, 1f)

            Text("${nm.label}: ${"%.1f".format(value)} / ${"%.1f".format(target)}")
            LinearProgressIndicator(progress = { ratio }, modifier = Modifier.fillMaxWidth().height(8.dp))
            Spacer(Modifier.height(8.dp))
        }

        Spacer(Modifier.height(16.dp))
        Text("ËÆ∞ÂΩïÊòéÁªÜÔºàÈ£üÁâ©Â∫ìÊò†Â∞ÑÔºâ", fontWeight = FontWeight.Bold)
        state.foods.forEach {
            ElevatedCard(Modifier.fillMaxWidth().padding(vertical = 4.dp)) {
                Row(Modifier.padding(12.dp), verticalAlignment = Alignment.CenterVertically) {
                    Column(Modifier.weight(1f)) {
                        Text("${it.food.name} ¬∑ ${"%.0f".format(it.entry.amount_g)} g")
                        val kcal = (it.entry.amount_g / 100.0) * it.food.calories_kcal_per_100g
                        Text("‚âà ${"%.0f".format(kcal)} kcal")
                    }
                    val scope = rememberCoroutineScope()
                    Button(onClick = { scope.launch { vm.deleteEntry(it.entry.id) } }) { Text("Âà†Èô§") }
                }
            }
        }

        Spacer(Modifier.height(8.dp))
        Text("ËÆ∞ÂΩïÊòéÁªÜÔºàAIËê•ÂÖªÁõ¥Âä†Ôºâ", fontWeight = FontWeight.Bold)
        state.customs.forEach {
            ElevatedCard(Modifier.fillMaxWidth().padding(vertical = 4.dp)) {
                Row(Modifier.padding(12.dp), verticalAlignment = Alignment.CenterVertically) {
                    Column(Modifier.weight(1f)) {
                        Text("${it.label} ¬∑ ‚âà ${"%.0f".format(it.calories_kcal)} kcal")
                        Text("ËõãÁôΩ ${it.protein_g} g | Á¢≥Ê∞¥ ${it.carbs_g} g | ËÑÇËÇ™ ${it.fat_g} g")
                        if (!it.notes.isNullOrBlank()) Text(it.notes!!)
                    }
                    val scope = rememberCoroutineScope()
                    Button(onClick = { scope.launch { vm.deleteCustom(it.id) } }) { Text("Âà†Èô§") }
                }
            }
        }
    }
}

@Composable
fun AddEntryScreen(vm: MainViewModel) {
    val foods by vm.foods.collectAsState()
    val scope = rememberCoroutineScope()

    Column(Modifier.padding(16.dp)) {
        Text("ËÆ∞ÂΩïÊëÑÂÖ•", style = MaterialTheme.typography.titleMedium, fontWeight = FontWeight.Bold)
        Spacer(Modifier.height(8.dp))

        if (foods.isEmpty()) {
            Text("ÂΩìÂâçÊ≤°ÊúâÈ£üÁâ©ÔºåËØ∑ÂÖàÊ∑ªÂä†Ëá™ÂÆö‰πâÈ£üÁâ©„ÄÇ")
            return
        }

        var selected by remember { mutableStateOf(foods.first()) }
        var mode by remember { mutableStateOf(0) } // 0=ÂÖã, 1=‰ªΩ
        var gramsText by remember { mutableStateOf("%.1f".format(selected.serving_size_g)) }
        var servingsText by remember { mutableStateOf("1.0") }
        var notes by remember { mutableStateOf("") }
        var showPicker by remember { mutableStateOf(false) }

        Button(onClick = { showPicker = true }) { Text("ÈÄâÊã©È£üÁâ©Ôºö${selected.name}") }
        if (showPicker) {
            AlertDialog(
                onDismissRequest = { showPicker = false },
                confirmButton = { TextButton({ showPicker = false }) { Text("ÂÖ≥Èó≠") } },
                text = {
                    Column(Modifier.fillMaxWidth().height(300.dp).verticalScroll(rememberScrollState())) {
                        foods.forEach { f ->
                            TextButton(onClick = {
                                selected = f
                                gramsText = "%.1f".format(f.serving_size_g)
                                showPicker = false
                            }) { Text(f.name) }
                        }
                    }
                }
            )
        }

        Spacer(Modifier.height(12.dp))
        Row(verticalAlignment = Alignment.CenterVertically) {
            FilterChip(selected = mode == 0, onClick = { mode = 0 }, label = { Text("ÊåâÂÖã(g)") })
            Spacer(Modifier.width(8.dp))
            FilterChip(selected = mode == 1, onClick = { mode = 1 }, label = { Text("Êåâ‰ªΩ") })
        }
        Spacer(Modifier.height(8.dp))

        if (mode == 0) {
            OutlinedTextField(
                value = gramsText,
                onValueChange = { gramsText = it },
                label = { Text("ÂÖãÊï∞(g)") },
                modifier = Modifier.fillMaxWidth()
            )
        } else {
            OutlinedTextField(
                value = servingsText,
                onValueChange = { servingsText = it },
                label = { Text("‰ªΩÊï∞") },
                modifier = Modifier.fillMaxWidth()
            )
            val amount = (servingsText.toDoubleOrNull() ?: 0.0) * selected.serving_size_g
            Text("Êç¢ÁÆóÂÖãÊï∞Ôºö${"%.0f".format(amount)} g")
        }

        Spacer(Modifier.height(8.dp))
        OutlinedTextField(value = notes, onValueChange = { notes = it }, label = { Text("Â§áÊ≥®(ÂèØÈÄâ)") }, modifier = Modifier.fillMaxWidth())

        Spacer(Modifier.height(12.dp))
        Button(onClick = {
            val amount = if (mode == 0) (gramsText.toDoubleOrNull() ?: 0.0)
            else (servingsText.toDoubleOrNull() ?: 0.0) * selected.serving_size_g
            if (amount > 0) scope.launch { vm.addEntry(amount, selected.id, notes.ifBlank { null }) }
        }) { Text("Ê∑ªÂä†ËÆ∞ÂΩï") }
    }
}

@Composable
fun FoodScreen(vm: MainViewModel) {
    val foods by vm.foods.collectAsState()
    val scope = rememberCoroutineScope()
    val scroll = rememberScrollState()

    var name by remember { mutableStateOf("") }
    var serving by remember { mutableStateOf("100.0") }
    var cal by remember { mutableStateOf("0.0") }
    var pro by remember { mutableStateOf("0.0") }
    var carb by remember { mutableStateOf("0.0") }
    var fat by remember { mutableStateOf("0.0") }
    var fiber by remember { mutableStateOf("0.0") }
    var sugar by remember { mutableStateOf("0.0") }
    var na by remember { mutableStateOf("0.0") }
    var ca by remember { mutableStateOf("0.0") }
    var fe by remember { mutableStateOf("0.0") }
    var vc by remember { mutableStateOf("0.0") }

    Column(Modifier.padding(16.dp).verticalScroll(scroll)) {
        Text("Ê∑ªÂä†Ëá™ÂÆö‰πâÈ£üÁâ©ÔºàÊØè100gÔºâ", fontWeight = FontWeight.Bold)
        OutlinedTextField(name, { name = it }, label = { Text("È£üÁâ©ÂêçÁß∞ *") }, modifier = Modifier.fillMaxWidth())
        Spacer(Modifier.height(8.dp))

        Row {
            OutlinedTextField(serving, { serving = it }, label = { Text("ÈªòËÆ§‰∏Ä‰ªΩ(g)") }, modifier = Modifier.weight(1f))
            Spacer(Modifier.width(8.dp))
            OutlinedTextField(cal, { cal = it }, label = { Text("kcal/100g") }, modifier = Modifier.weight(1f))
        }
        Spacer(Modifier.height(8.dp))

        Row {
            OutlinedTextField(pro, { pro = it }, label = { Text("ËõãÁôΩ g/100g") }, modifier = Modifier.weight(1f))
            Spacer(Modifier.width(8.dp))
            OutlinedTextField(carb, { carb = it }, label = { Text("Á¢≥Ê∞¥ g/100g") }, modifier = Modifier.weight(1f))
            Spacer(Modifier.width(8.dp))
            OutlinedTextField(fat, { fat = it }, label = { Text("ËÑÇËÇ™ g/100g") }, modifier = Modifier.weight(1f))
            Spacer(Modifier.width(8.dp))
            OutlinedTextField(fiber, { fiber = it }, label = { Text("Á∫§Áª¥ g/100g") }, modifier = Modifier.weight(1f))
        }
        Spacer(Modifier.height(8.dp))
        Row {
            OutlinedTextField(sugar, { sugar = it }, label = { Text("Á≥ñ g/100g") }, modifier = Modifier.weight(1f))
            Spacer(Modifier.width(8.dp))
            OutlinedTextField(na, { na = it }, label = { Text("Èí† mg/100g") }, modifier = Modifier.weight(1f))
            Spacer(Modifier.width(8.dp))
            OutlinedTextField(ca, { ca = it }, label = { Text("Èíô mg/100g") }, modifier = Modifier.weight(1f))
            Spacer(Modifier.width(8.dp))
            OutlinedTextField(fe, { fe = it }, label = { Text("ÈìÅ mg/100g") }, modifier = Modifier.weight(1f))
        }
        Spacer(Modifier.height(8.dp))
        OutlinedTextField(vc, { vc = it }, label = { Text("Áª¥C mg/100g") }, modifier = Modifier.fillMaxWidth())

        Spacer(Modifier.height(8.dp))
        Button(onClick = {
            val f = Food(
                name = name.trim(),
                serving_size_g = serving.toDoubleOrNull() ?: 100.0,
                calories_kcal_per_100g = cal.toDoubleOrNull() ?: 0.0,
                protein_g_per_100g = pro.toDoubleOrNull() ?: 0.0,
                carbs_g_per_100g = carb.toDoubleOrNull() ?: 0.0,
                fat_g_per_100g = fat.toDoubleOrNull() ?: 0.0,
                fiber_g_per_100g = fiber.toDoubleOrNull() ?: 0.0,
                sugar_g_per_100g = sugar.toDoubleOrNull() ?: 0.0,
                sodium_mg_per_100g = na.toDoubleOrNull() ?: 0.0,
                calcium_mg_per_100g = ca.toDoubleOrNull() ?: 0.0,
                iron_mg_per_100g = fe.toDoubleOrNull() ?: 0.0,
                vitamin_c_mg_per_100g = vc.toDoubleOrNull() ?: 0.0
            )
            if (f.name.isNotBlank()) {
                scope.launch {
                    vm.addFood(f) {
                        name = ""; serving = "100.0"; cal = "0.0"; pro = "0.0"; carb = "0.0"; fat = "0.0"
                        fiber = "0.0"; sugar = "0.0"; na = "0.0"; ca = "0.0"; fe = "0.0"; vc = "0.0"
                    }
                }
            }
        }) { Text("Ê∑ªÂä†Âà∞È£üÁâ©Â∫ì") }

        Spacer(Modifier.height(16.dp))
        Text("ÂΩìÂâçÈ£üÁâ©Â∫ìÔºà${foods.size}Ôºâ", fontWeight = FontWeight.Bold)
        foods.forEach { Text("‚Ä¢ ${it.name}") }
    }
}

@Composable
fun GoalsScreen(vm: MainViewModel) {
    val g by vm.goalState.collectAsState()
    val scope = rememberCoroutineScope()
    var goal by remember { mutableStateOf(g) }

    Column(Modifier.padding(16.dp).verticalScroll(rememberScrollState())) {
        Text("ÊØèÊó•ÁõÆÊ†á", fontWeight = FontWeight.Bold)

        OutlinedTextField(
            value = "%.1f".format(goal.calories_kcal ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(calories_kcal = v) } },
            label = { Text("ÁÉ≠Èáè kcal") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        OutlinedTextField(
            value = "%.1f".format(goal.protein_g ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(protein_g = v) } },
            label = { Text("ËõãÁôΩË¥® g") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        OutlinedTextField(
            value = "%.1f".format(goal.carbs_g ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(carbs_g = v) } },
            label = { Text("Á¢≥Ê∞¥ g") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        OutlinedTextField(
            value = "%.1f".format(goal.fat_g ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(fat_g = v) } },
            label = { Text("ËÑÇËÇ™ g") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        OutlinedTextField(
            value = "%.1f".format(goal.fiber_g ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(fiber_g = v) } },
            label = { Text("ËÜ≥È£üÁ∫§Áª¥ g") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        OutlinedTextField(
            value = "%.1f".format(goal.sugar_g ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(sugar_g = v) } },
            label = { Text("Á≥ñ g") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        OutlinedTextField(
            value = "%.1f".format(goal.sodium_mg ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(sodium_mg = v) } },
            label = { Text("Èí† mg") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        OutlinedTextField(
            value = "%.1f".format(goal.calcium_mg ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(calcium_mg = v) } },
            label = { Text("Èíô mg") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        OutlinedTextField(
            value = "%.1f".format(goal.iron_mg ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(iron_mg = v) } },
            label = { Text("ÈìÅ mg") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        OutlinedTextField(
            value = "%.1f".format(goal.vitamin_c_mg ?: 0.0),
            onValueChange = { it.toDoubleOrNull()?.let { v -> goal = goal.copy(vitamin_c_mg = v) } },
            label = { Text("Áª¥ÁîüÁ¥†C mg") }, modifier = Modifier.fillMaxWidth()
        ); Spacer(Modifier.height(8.dp))

        Button(onClick = { scope.launch { vm.updateGoal(goal) } }) { Text("‰øùÂ≠òÁõÆÊ†á") }
    }
}

@Composable
fun ExportScreen(vm: MainViewModel) {
    val day by vm.day.collectAsState()
    val context = LocalContext.current

    var pendingCsv by remember { mutableStateOf<String?>(null) }
    val createLauncher = rememberLauncherForActivityResult(CreateDocument("text/csv")) { uri: Uri? ->
        val csv = pendingCsv ?: return@rememberLauncherForActivityResult
        if (uri != null) writeTextToUri(context, uri, csv)
        pendingCsv = null
    }

    Column(Modifier.padding(16.dp)) {
        Text("ÂØºÂá∫Êï∞ÊçÆ", fontWeight = FontWeight.Bold)
        Spacer(Modifier.height(8.dp))
        Button(onClick = {
            val d = day ?: return@Button
            val rows = buildList {
                // entries
                d.foods.forEach { ef ->
                    val factor = ef.entry.amount_g / 100.0
                    val map = mutableMapOf<String, Double>()
                    NUTRIENTS_META.forEach { nm ->
                        val per100 = when (nm.per100Column) {
                            "calories_kcal_per_100g" -> ef.food.calories_kcal_per_100g
                            "protein_g_per_100g" -> ef.food.protein_g_per_100g
                            "carbs_g_per_100g" -> ef.food.carbs_g_per_100g
                            "fat_g_per_100g" -> ef.food.fat_g_per_100g
                            "fiber_g_per_100g" -> ef.food.fiber_g_per_100g
                            "sugar_g_per_100g" -> ef.food.sugar_g_per_100g
                            "sodium_mg_per_100g" -> ef.food.sodium_mg_per_100g
                            "calcium_mg_per_100g" -> ef.food.calcium_mg_per_100g
                            "iron_mg_per_100g" -> ef.food.iron_mg_per_100g
                            "vitamin_c_mg_per_100g" -> ef.food.vitamin_c_mg_per_100g
                            else -> 0.0
                        }
                        map[nm.key] = factor * per100
                    }
                    add(listOf(
                        d.goal.id.toString(),
                        d.goal.calories_kcal?.toString() ?: "",
                        "food",
                        ef.food.name,
                        "%.1f".format(ef.entry.amount_g),
                        *(NUTRIENTS_META.map { "%.2f".format(map[it.key] ?: 0.0) }.toTypedArray()),
                        ef.entry.notes ?: ""
                    ))
                }
                // custom_entries
                d.customs.forEach { c ->
                    add(listOf(
                        d.goal.id.toString(),
                        d.goal.calories_kcal?.toString() ?: "",
                        "custom",
                        c.label,
                        "",
                        *(NUTRIENTS_META.map { key -> "%.2f".format(
                            when (key.key) {
                                "calories_kcal" -> c.calories_kcal
                                "protein_g" -> c.protein_g
                                "carbs_g" -> c.carbs_g
                                "fat_g" -> c.fat_g
                                "fiber_g" -> c.fiber_g
                                "sugar_g" -> c.sugar_g
                                "sodium_mg" -> c.sodium_mg
                                "calcium_mg" -> c.calcium_mg
                                "iron_mg" -> c.iron_mg
                                "vitamin_c_mg" -> c.vitamin_c_mg
                                else -> 0.0
                            }
                        ) }.toTypedArray()),
                        c.notes ?: ""
                    ))
                }
            }
            val header = listOf("goal_id", "kcal_goal", "type", "label", "amount_g", *NUTRIENTS_META.map { it.key }.toTypedArray(), "notes")
            val csv = buildString {
                appendLine(header.joinToString(","))
                rows.forEach { appendLine(it.joinToString(",")) }
            }
            pendingCsv = csv
            createLauncher.launch("nutrition_${vm.today.value}.csv")
        }) { Text("‰∏ãËΩΩÂΩìÊó•ËÆ∞ÂΩï CSV") }
    }
}

private fun writeTextToUri(context: Context, uri: Uri, text: String) {
    context.contentResolver.openOutputStream(uri)?.use { os ->
        OutputStreamWriter(os, Charsets.UTF_8).use { it.write(text) }
    }
}

@Composable
fun TrendScreen(vm: MainViewModel) {
    var data by remember { mutableStateOf<List<Pair<String, Map<String, Double>>>>(emptyList()) }
    LaunchedEffect(Unit) { data = vm.weekTrend() }

    Column(Modifier.padding(16.dp)) {
        Text("ÊúÄËøë 7 Â§©Ë∂ãÂäøÔºàcustom Âè£ÂæÑÔºâ", fontWeight = FontWeight.Bold)
        Spacer(Modifier.height(12.dp))
        if (data.isEmpty()) {
            Text("ËøáÂéª 7 Â§©Ê≤°ÊúâËÆ∞ÂΩï„ÄÇ")
        } else {
            Column {
                data.forEach { (d, sums) ->
                    Text("$d  ¬∑ kcal=${"%.0f".format(sums["calories_kcal"] ?: 0.0)}  | P=${"%.0f".format(sums["protein_g"] ?: 0.0)} C=${"%.0f".format(sums["carbs_g"] ?: 0.0)} F=${"%.0f".format(sums["fat_g"] ?: 0.0)}")
                }
            }
        }
    }
}

@Composable
fun AiScreen(vm: MainViewModel) {
    val ctx = LocalContext.current
    val scope = rememberCoroutineScope()

    // ‰ªé ViewModel ÂèñÊï∞ÊçÆÂ∫ìÈáåÁöÑÈÖçÁΩÆÂàóË°®‰∏éÂΩìÂâçÈÄâÊã©
    val settings by vm.apiSettings.collectAsState()
    val active by vm.activeProvider.collectAsState()

    // Âè™‰øùÁïô‰∏âÂÆ∂ÁöÑ‚ÄúÊ®°ÊùøÈªòËÆ§ÂÄº‚ÄùÔºåÁî®‰∫éÊñ∞Âª∫Êó∂Âø´ÈÄüÂ°´ÈªòËÆ§Ê®°Âûã/Endpoint
    fun defaultModel(p: String) = when (p) {
        "Kimi (Moonshot)" -> "moonshot-v1-8k"
        "Qwen (DashScope)" -> "qwen2.5-vl"
        "Doubao (Ark)"    -> "doubao-vision-lite"
        else              -> "qwen2.5-vl"
    }
    fun defaultEndpoint(p: String) = when (p) {
        "Kimi (Moonshot)" -> "https://api.moonshot.cn/v1/chat/completions"
        "Qwen (DashScope)"-> "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
        "Doubao (Ark)"    -> "https://ark.cn-beijing.volces.com/api/v3/chat/completions"
        else              -> "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
    }

    // ÂΩìÂâçÁºñËæëË°®ÂçïÔºàÊù•Ëá™ÈÄâ‰∏≠ÁöÑÈÖçÁΩÆ or Êñ∞Âª∫Ôºâ
    var provider by remember(active, settings) {
        mutableStateOf(active ?: settings.firstOrNull()?.provider ?: "Kimi (Moonshot)")
    }
    var apiKey by remember { mutableStateOf("") }
    var model by remember { mutableStateOf(defaultModel(provider)) }
    var endpoint by remember { mutableStateOf(defaultEndpoint(provider)) }
    var extra by remember { mutableStateOf("Â¶ÇÊúâÂèØËßÅÈ§êÂÖ∑ÊàñÊâãÈÉ®ÔºåËØ∑Áî®‰∫é‰º∞ÁÆóÊØî‰æã„ÄÇËã•‰∏∫Â§çÂêàËèúËÇ¥ÔºåËØ∑ÊãÜÂàÜ‰∏ªË¶ÅÊàêÂàÜ„ÄÇ") }

    // ÂΩì active/provider Êàñ settings ÂèòÂåñÊó∂ÔºåÊääË°®ÂçïÂêåÊ≠•‰∏∫Êï∞ÊçÆÂ∫ìÈáå‰øùÂ≠òÁöÑÂÄº
    LaunchedEffect(provider, settings) {
        val s = settings.firstOrNull { it.provider == provider }
        if (s != null) {
            apiKey = s.api_key ?: ""
            model = s.model ?: defaultModel(provider)
            endpoint = s.endpoint ?: defaultEndpoint(provider)
        } else {
            // Êñ∞Âª∫ÔºöÊ†πÊçÆÊ®°ÊùøÊèê‰æõÈªòËÆ§ÂÄº
            apiKey = ""
            model = defaultModel(provider)
            endpoint = defaultEndpoint(provider)
        }
    }

    // ÂõæÁâáÈÄâÊã©
    var picked by remember { mutableStateOf<Uri?>(null) }
    val imagePicker = rememberLauncherForActivityResult(
        ActivityResultContracts.PickVisualMedia()
    ) { uri -> picked = uri }

    // ËøêË°åÁä∂ÊÄÅ
    var loading by remember { mutableStateOf(false) }
    var rawText by remember { mutableStateOf<String?>(null) }
    var parsed by remember { mutableStateOf(AiParsed()) }
    var error by remember { mutableStateOf<String?>(null) }

    Column(Modifier.padding(16.dp).verticalScroll(rememberScrollState())) {
        Text("üì∑ ÂõæÁâá AI Ëê•ÂÖªÂàÜÊûê", style = MaterialTheme.typography.titleMedium)

        Spacer(Modifier.height(8.dp))
        Text("ÈÄâÊã©/Êñ∞Âª∫ API ÈÖçÁΩÆ")
        Spacer(Modifier.height(4.dp))

        // ‰∏ãÊãâÊ°ÜÔºöÊï∞ÊçÆÂ∫ìÂ∑≤ÊúâÁöÑ provider + ‰∏âÂÆ∂Ê®°ÊùøÔºàÂéªÈáçÔºâ
        val dbProviders = settings.map { it.provider }
        val templateProviders = listOf("Kimi (Moonshot)", "Qwen (DashScope)", "Doubao (Ark)")
        val allProviders = (dbProviders + templateProviders).distinct()

        var expanded by remember { mutableStateOf(false) }
        ExposedDropdownMenuBox(expanded = expanded, onExpandedChange = { expanded = it }) {
            OutlinedTextField(
                value = provider,
                onValueChange = {},
                readOnly = true,
                label = { Text("‰ΩøÁî®ÁöÑ API ÈÖçÁΩÆ") },
                trailingIcon = { ExposedDropdownMenuDefaults.TrailingIcon(expanded) },
                modifier = Modifier.menuAnchor().fillMaxWidth()
            )
            ExposedDropdownMenu(expanded = expanded, onDismissRequest = { expanded = false }) {
                allProviders.forEach { p ->
                    DropdownMenuItem(
                        text = { Text(p) },
                        onClick = {
                            expanded = false
                            provider = p
                            vm.selectApiProvider(p)
                        }
                    )
                }
                DropdownMenuItem(
                    text = { Text("Ôºã Êñ∞Âª∫Ëá™ÂÆö‰πâÈÖçÁΩÆ‚Ä¶") },
                    onClick = {
                        expanded = false
                        provider = "Ëá™ÂÆö‰πâAPI"
                        vm.selectApiProvider(provider)
                        apiKey = ""
                        model = ""
                        endpoint = ""
                    }
                )
            }
        }

        Spacer(Modifier.height(8.dp))
        OutlinedTextField(value = provider, onValueChange = { provider = it }, label = { Text("ÂêçÁß∞ÔºàÂîØ‰∏ÄÔºâ") }, modifier = Modifier.fillMaxWidth())
        Spacer(Modifier.height(8.dp))
        OutlinedTextField(
            value = apiKey, onValueChange = { apiKey = it },
            label = { Text("API Key") },
            visualTransformation = PasswordVisualTransformation(),
            modifier = Modifier.fillMaxWidth()
        )
        Spacer(Modifier.height(8.dp))
        OutlinedTextField(value = model, onValueChange = { model = it }, label = { Text("Ê®°Âûã") }, modifier = Modifier.fillMaxWidth())
        Spacer(Modifier.height(8.dp))
        OutlinedTextField(value = endpoint, onValueChange = { endpoint = it }, label = { Text("API Endpoint") }, modifier = Modifier.fillMaxWidth())
        Spacer(Modifier.height(8.dp))
        OutlinedTextField(value = extra, onValueChange = { extra = it }, label = { Text("È¢ùÂ§ñËØ¥ÊòéÔºàÂèØÈÄâÔºâ") }, modifier = Modifier.fillMaxWidth())

        Spacer(Modifier.height(8.dp))
        Row {
            Button(onClick = {
                vm.saveApiSetting(provider.trim(), apiKey.trim(), model.trim(), endpoint.trim())
            }) { Text("üíæ ‰øùÂ≠ò/Êõ¥Êñ∞Ê≠§ÈÖçÁΩÆ") }

            Spacer(Modifier.width(8.dp))
            val exists = settings.any { it.provider == provider }
            OutlinedButton(
                enabled = exists,
                onClick = { vm.deleteApiSetting(provider) }
            ) { Text("üóë Âà†Èô§Ê≠§ÈÖçÁΩÆ") }
        }

        Divider(Modifier.padding(vertical = 12.dp))

        Row {
            Button(onClick = {
                imagePicker.launch(PickVisualMediaRequest(ActivityResultContracts.PickVisualMedia.ImageOnly))
            }) { Text(if (picked == null) "ÈÄâÊã©ÂõæÁâá" else "ÈáçÊñ∞ÈÄâÊã©ÂõæÁâá") }

            Spacer(Modifier.width(12.dp))
            if (picked != null) {
                AsyncImage(model = picked, contentDescription = null, modifier = Modifier.size(80.dp))
            }
        }

        Spacer(Modifier.height(12.dp))
        Button(
            enabled = picked != null && apiKey.isNotBlank() && model.isNotBlank() && endpoint.isNotBlank() && !loading,
            onClick = {
                loading = true; error = null; rawText = null; parsed = AiParsed()
                scope.launch {
                    try {
                        val bytes = withContext(Dispatchers.IO) {
                            compressImage(ctx, picked!!)   // ÂéãÁº©Âú® IO Á∫øÁ®ãÂÅö
                        }
                        val dataUrl = bytesToDataUrl(bytes)
                        val req = buildChatRequest(model, dataUrl, extra)
                        val svc = buildRetrofit().create(AiService::class.java)
                        val resp = svc.chat(endpoint, "Bearer $apiKey", req)
                        val content = resp.choices.firstOrNull()?.message?.content.orEmpty()
                        rawText = content
                        parsed = parseAiJson(content)
                    } catch (e: java.net.SocketTimeoutException) {
                        error = "ËØ∑Ê±ÇË∂ÖÊó∂ÔºöËØ∑ÈáçËØïÊàñÊç¢Êõ¥Â∞èÁöÑÂõæÁâá/Êõ¥Âø´ÁöÑÁΩëÁªú„ÄÇ"
                    } catch (e: Exception) {
                        error = e.message ?: e.toString()
                    } finally {
                        loading = false
                    }
                }

            }
        ) { Text(if (loading) "ÂàÜÊûê‰∏≠‚Ä¶" else "ÂºÄÂßãÂàÜÊûêÔºà‰ΩøÁî®‰∏äÊñπÈÄâÊã©ÁöÑ APIÔºâ") }


        if (error != null) {
            Spacer(Modifier.height(8.dp)); Text("ÈîôËØØÔºö$error", color = MaterialTheme.colorScheme.error)
        }

        if (rawText != null) {
            Spacer(Modifier.height(12.dp))
            Text("AI ÂéüÂßã JSONÔºàÊà™Êñ≠Â±ïÁ§∫Ôºâ")
            Text(rawText!!.take(1200))
        }

        if (parsed.items.isNotEmpty()) {
            Spacer(Modifier.height(12.dp))
            parsed.serving_context?.takeIf { it.isNotBlank() }?.let { Text("‰∏ä‰∏ãÊñáÔºö$it"); Spacer(Modifier.height(4.dp)) }
            parsed.error_margin_pct?.let { Text("ËØØÂ∑ÆÁ∫¶Ôºö$it%"); Spacer(Modifier.height(4.dp)) }
            parsed.advice?.takeIf { it.isNotBlank() }?.let { Text("Âª∫ËÆÆÔºö$it"); Spacer(Modifier.height(8.dp)) }

            val selections = remember(parsed) { mutableStateListOf<Boolean>().apply { repeat(parsed.items.size) { add(true) } } }
            parsed.items.forEachIndexed { idx, it ->
                ElevatedCard(Modifier.fillMaxWidth().padding(vertical = 6.dp)) {
                    Column(Modifier.padding(12.dp)) {
                        Row(verticalAlignment = Alignment.CenterVertically) {
                            Checkbox(checked = selections[idx], onCheckedChange = { selections[idx] = it })
                            Text("${it.name} ¬∑ ‰º∞ÁÆó ${"%.0f".format(it.estimated_weight_g ?: 0.0)} g ¬∑ ÁΩÆ‰ø° ${"%.2f".format(it.confidence ?: 0.0)}")
                        }
                        Text("‚âà ${"%.0f".format(it.calories_kcal ?: 0.0)} kcal | P ${it.protein_g} g | C ${it.carbs_g} g | F ${it.fat_g} g")
                        it.notes?.takeIf { s -> s.isNotBlank() }?.let { n -> Text(n) }
                    }
                }
            }

            Spacer(Modifier.height(8.dp))
            Button(onClick = {
                scope.launch {
                    var count = 0
                    parsed.items.forEachIndexed { i, it ->
                        if (!selections[i]) return@forEachIndexed
                        vm.addCustomFromAI(
                            label = it.name,
                            calories = it.calories_kcal ?: 0.0,
                            protein = it.protein_g ?: 0.0,
                            carbs = it.carbs_g ?: 0.0,
                            fat = it.fat_g ?: 0.0,
                            fiber = it.fiber_g ?: 0.0,
                            sugar = it.sugar_g ?: 0.0,
                            sodium = it.sodium_mg ?: 0.0,
                            calcium = it.calcium_mg ?: 0.0,
                            iron = it.iron_mg ?: 0.0,
                            vitaminC = it.vitamin_c_mg ?: 0.0,
                            notes = "AI: ${it.notes ?: ""}",
                            source = "AI:${provider}"
                        )
                        count++
                    }
                }
            }) { Text("‚úÖ Ê∑ªÂä†ÈÄâ‰∏≠È°πÔºàAI Áõ¥Âä†Ôºâ") }
        }
    }
}

